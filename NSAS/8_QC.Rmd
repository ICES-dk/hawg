---
output: 
  word_document:
    reference_docx: ../_Common/report_template_v1.5.dotx
---

```{r setup, include=FALSE}
# ==============================================================================
# North Sea herring; quality control (and miscellaneous visualization)
#
# 22/03/2020 first coding
# ==============================================================================

require("knitr")
knitr::opts_chunk$set(
  echo = FALSE,	message = FALSE,	warning = FALSE,	comment = "",	crop = TRUE, fig.width=10) 
rm(list=ls())

#library(devtools)  ## install.packages("devtools")
library(FLCore)
library(FLSAM)
library(tidyverse)
library(RColorBrewer)

# local path (not needed in RMarkdown)

# source publication theme
source("../_common/theme_publication.r")

# Load crayola code
source("../_common/crayola.r")

# Create QC directory
dir.create("qc",showWarnings = FALSE)

# Other settings
output.dir          <-  file.path(".","qc/")              # result directory\

assessment_name     <- 'NSH_HAWG2020_sf'
y1                  <- 2019
y2                  <- 2020

# read in data objects of previous year
load("//community.ices.dk@SSL/DavWWWRoot/ExpertGroups/HAWG/2019 Meeting Docs/06. Data/NSAS/NSH_HAWG2019_sf.Rdata") 
s.y1      <- NSH
s.ctrl.y1 <- NSH.ctrl
s.sam.y1  <- NSH.sam
s.tun.y1  <- NSH.tun
ly.y1     <- an(range(s.y1)["maxyear"])

stf.y1    <- get(load(file.path('stf',y1,paste0('NSAS_stf_',y1,'.RData'))))#[["stf"]]


load("//community.ices.dk@SSL/DavWWWRoot/ExpertGroups/HAWG/2020 Meeting Docs/06. Data/her.27.3a47d/NSH_HAWG2020_sf.Rdata")
s.y2      <- NSH
s.ctrl.y2 <- NSH.ctrl
s.sam.y2  <- NSH.sam
s.tun.y2  <- NSH.tun
ly.y2     <- an(range(s.y2)["maxyear"])

stf.y2    <- get(load(file.path('stf',paste0('NSAS_stf_',y2,'.RData'))))#[["stf"]]

rm(NSH, NSH.ctrl, NSH.sam, NSH.tun)

```

**Quality control of `r assessment_name` assessment**

**Martin Pastoors^1^**

`r format(Sys.time(), '%d/%m/%Y %H:%M')`


```{r echo=FALSE, fig.align="center", fig.asp=1.0, message=FALSE, warning=FALSE}

# Figure 2.2.4.x1 Data check on biological input data 
df.y1 <- as.data.frame(s.y1) %>% mutate(assessmentyear = ac(y1)) 
df.y2 <- as.data.frame(s.y2) %>% mutate(assessmentyear = ac(y2)) 
  
bind_rows(df.y1, df.y2) %>%
  filter(slot %in% c("catch", "catch.n","catch.wt", "harvest.spwn", "m.spwn","m","mat", "stock.wt")) %>% 
  ggplot(aes(x=year, y=data)) +
  theme_publication() +
  theme(legend.position="bottom") +
  geom_line(aes(colour=assessmentyear)) +
  # labs(title=myvar) +
  facet_grid(slot~age, scale="free_y")

```

**Figure 2.2.4.x1. North Sea Herring. Data check on biological input data, comparing data of the `r y1` and `r y2` assessments.**

```{r echo=FALSE, fig.align="center", fig.asp=1.0, message=FALSE, warning=FALSE}

# Figure 2.2.4.x2 Data check on biological input data 
# df.y1 <- as.data.frame(s.y1) %>% mutate(assessmentyear = ac(y1)) 
# df.y2 <- as.data.frame(s.y2) %>% mutate(assessmentyear = ac(y2)) 
  
bind_rows(df.y1, df.y2) %>%
  filter(slot %in% c("catch", "catch.n","catch.wt", "harvest.spwn", "m.spwn","m","mat", "stock.wt")) %>% 
  filter(data != -1) %>% 
  arrange(slot, age, year, unit, season, area, iter, assessmentyear) %>% 
  group_by(slot, age, year, unit, season, area, iter) %>% 
  mutate(data1 = lag(data, n=1)) %>% 
  filter(data1 != -1, !is.na(data1)) %>% 
  mutate(perc = 100*((data1/data)-1)) %>% 

  ggplot(aes(x=year, y=perc)) +
  theme_publication() +
  theme(legend.position="bottom") +
  geom_hline(yintercept=0, colour="black", linetype="dashed") +
  geom_line(colour="red", size=1) +
  labs(y="perc diff") +
  facet_grid(slot~age)

```

**Figure 2.2.4.x2. North Sea Herring. Data check on biological input data, relative difference between the `r y1` and `r y2` assessments.**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=1.0, message=FALSE, warning=FALSE}

# Figure 2.2.4.x3 Data check on survey input data 
df.tun.y1 <- as.data.frame(s.tun.y1) %>% mutate(assessmentyear = ac(y1)) 
df.tun.y2 <- as.data.frame(s.tun.y2) %>% mutate(assessmentyear = ac(y2)) 

bind_rows(df.tun.y1, df.tun.y2) %>%
  filter(slot %in% c("index")) %>% 
  ggplot(aes(x=year, y=data)) +
  theme_publication() +
  theme(legend.position="bottom") +
  geom_line(aes(colour=assessmentyear)) +
  # labs(title=myvar) +
  facet_grid(cname~age, scale="free_y")

```

**Figure 2.2.4.x4. North Sea Herring. Data check on survey input data, relative difference between the `r y1` and `r y2` assessments.**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=1.0, message=FALSE, warning=FALSE}

# Figure 2.2.4.x4 Data check on relative difference in survey input data 
df.tun.y1 <- as.data.frame(s.tun.y1) %>% mutate(assessmentyear = ac(y1)) 
df.tun.y2 <- as.data.frame(s.tun.y2) %>% mutate(assessmentyear = ac(y2)) 

bind_rows(df.tun.y1, df.tun.y2) %>%
      filter(slot=="index") %>%
      filter(data != -1) %>% 
      arrange(slot, age, year, unit, season, area, iter, cname, assessmentyear) %>% 
      group_by(slot, age, year, unit, season, area, iter, cname) %>% 
      mutate(data1 = lag(data, n=1)) %>% 
      filter(data1 != -1) %>% 
      mutate(perc = 100*((data1/data)-1)) %>% 
      
      ggplot(aes(x=year, y=perc)) +
      theme_bw() +
      theme(legend.position="none") +
      geom_hline(yintercept=0, colour="black", linetype="dashed") +
      geom_line(colour="red", size=1) +
      labs(x="",y="") +
      facet_grid(cname~age)


```

**Figure 2.2.4.x4. North Sea Herring. Data check on survey input data, comparing data of the `r y1` and `r y2` assessments.**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=0.6, message=FALSE, warning=FALSE}

# Figure 2.6.1.2, Crayola catch

trim(slot(s.y2,"catch.n"), year=(ly.y2-25):ly.y2, age=0:8) %>% 
  as.data.frame() %>% 
  dplyr::select(year, age, number = data) %>% 
  filter(number != -1) %>% 
  crayola(., t="North Sea herring catch at age")

```

**Figure 2.6.1.2. North Sea Herring. Time series of catch-at-age proportion at ages 0–8+ as used in the North Sea herring assessment. Colours indicate year-classes. All ages are scaled independently and therefore the size of the bars can only be compared within an age.**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=0.6, message=FALSE, warning=FALSE}

# Figure 2.6.1.4, Crayola heras

trim(s.tun.y2[["HERAS"]]@index, year=(ly.y2-25):ly.y2, age=1:8) %>% 
  as.data.frame() %>% 
  dplyr::select(year, age, number = data) %>% 
  filter(number != -1) %>% 
  crayola(., t = "North Sea herring HERAS survey")


```

**Figure 2.6.1.4. North Sea Herring. Time series of the HERAS acoustic index by age 1–8+. Colours indicate year-classes. All ages are scaled independently and cannot be compared between ages.**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=0.6, message=FALSE, warning=FALSE}

# Figure 2.7.2.1. Predicted and projected catch (in weight) 

catch.y1  <- as.data.frame(stf.y1@catch.n * stf.y1@catch.wt) %>% mutate(stf=ac(y1))
catch.y2  <- as.data.frame(stf.y2@catch.n * stf.y2@catch.wt) %>% mutate(stf=ac(y2))

bind_rows(catch.y1,catch.y2) %>% 
  mutate(age = paste0(age," wr")) %>% 
  filter(unit=="A") %>% 

  ggplot(aes(x=year, y=data, group=stf)) +
  theme_publication() +
  geom_line(aes(colour=stf), size=1) +
  labs(x="", y="catch (tonnes)", colour="HAWG") +
  facet_wrap(~age)

```

**Figure 2.7.2.1. North Sea Herring. Predicted and projected catch (in weight) between `r y1` assessment (`r y1+1` as forecast year) and `r y2` assessment (`r y2+1` as forecast year).**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=0.6, message=FALSE, warning=FALSE}

# Figure 2.7.2.2. Predicted and projected catch (in weight) 

catch.y1  <- as.data.frame(stf.y1@catch.n * stf.y1@catch.wt) %>% mutate(stf=ac(y1))
catch.y2  <- as.data.frame(stf.y2@catch.n * stf.y2@catch.wt) %>% mutate(stf=ac(y2))

bind_rows(catch.y1,catch.y2) %>% 
  mutate(age = paste0(age," wr")) %>% 
  mutate(stf = paste0("HAWG ", stf)) %>% 
  filter(unit=="A") %>% 

  ggplot(aes(x=year, y=data, group=stf)) +
  theme_bw() +
  geom_bar(aes(fill=as.character(age)), stat="identity", colour="white") +
  labs(x = "", y= "catch (tonnes)", fill="age (WR)") +
  facet_wrap(~stf)

```

**Figure 2.7.2.2. North Sea Herring. Catch proportions for the different ages between the  `r y1` assessment (`r y1+1` as forecast year) and `r y2` assessment (`r y2+1` as forecast year).**

##### page break

```{r echo=FALSE, fig.align="center", fig.asp=0.6, message=FALSE, warning=FALSE}

# Figure 2.7.2.3. Longer term short-term projections

library(minpack.lm)  # install.packages("minpack.lm")
require(msm)         # install.packages("msm")

load("//community.ices.dk@SSL/DavWWWRoot/ExpertGroups/HAWG/2020 Meeting Docs/06. Data/her.27.3a47d/NSH_HAWG2020_sf.Rdata")
load("//community.ices.dk@SSL/DavWWWRoot/ExpertGroups/HAWG/2020 Meeting Docs/06. Data/her.27.3a47d/NSH_HAWG2020_mf.Rdata")
# load(file=file.path(output.dir,"NSH_HAWG2020_sf.RData"))
# load(file=file.path(output.dir,"NSH_HAWG2020_mf.RData"))

dataPath      <- file.path(".","data/")
outPath       <- file.path(".","stf")
functionPath  <- file.path(".","functions/")
scriptPath    <- file.path(".","side_script/")

# ImY forecast functions
source(file.path(functionPath,"fleet.harvest.r"))
source(file.path(functionPath,"rescaleF.r"))

# fmsyAR function
source(file.path(functionPath,"fmsyAR_fun.r"))
source(file.path(functionPath,"find.FCAR.r"))

source(file.path(functionPath,"fmsyAR_fun_transfer.r"))
source(file.path(functionPath,"fmsyAR_fun_no_transfer.r"))

# MP functions
source(file.path(functionPath,"find.FAB_HCRA.r"))
source(file.path(functionPath,"find.FAB_HCRB.r"))
source(file.path(functionPath,"CATCH2sel.r"))     # Find F that matches a certain catch
source(file.path(functionPath,"MP_fun.r"))        # Management plan function

# no fishing function
source(file.path(functionPath,"nf_fun.r"))

# TAC scaling functions
source(file.path(functionPath,"TAC_scaling_fun.r"))
source(file.path(functionPath,"fleet.harvest2.r")) # only used for having FBsq
source(file.path(functionPath,"rescaleF_FBsq.r")) # only used for having FBsq

# F scaling functions
source(file.path(functionPath,"F_scaling_fun.r"))
source(file.path(functionPath,"find.FC.r"))

# B scaling function
source(file.path(functionPath,"B_scaling_fun.r"))
source(file.path(functionPath,"find.BC.r"))

# auxiliary
source(file.path(functionPath,"harvestCatch.r"))
source(file.path(functionPath,"writeSTF.out.r"))

#-------------------------------------------------------------------------------
# 2) setup control variables
#-------------------------------------------------------------------------------

DtY   <- ac(range(NSH)["maxyear"]) #Data year
ImY   <- ac(an(DtY)+1)             #Intermediate year
FcY   <- ac(an(DtY)+2)             #Forecast year
CtY   <- ac(an(DtY)+3)             #Continuation year
CtY1  <- ac(an(DtY)+4)
FuY   <- c(ImY,FcY,CtY)            #Future years


# flag on TAC assumptions for C and D fleet. 
# If true, one takes TAC from WBSS advice
# If false, one takes TAC from ImY
TAC_CD_advice   <- TRUE

if(TAC_CD_advice == TRUE){
  stfFileName   <- paste0('NSAS_stf_',ImY)
}else{
  stfFileName   <- paste0('NSAS_stf_CD_TAC_sq_',ImY)
}

# slots copied from last year of assessment
yrs1        <- list("m.spwn","harvest.spwn","stock.wt")

# slots copied as mean of last 3 years of assessment
yrs3        <- list("mat")

# slots copied as mean of last 5 years of assessment
yrs5        <- list("m")

dsc         <- "North Sea Herring"
nam         <- "NSH"
dms         <- dimnames(NSH@m)
dms$year    <- c(rev(rev(dms$year)[1:3]),ImY,FcY,CtY)
dms$unit    <- c("A","B","C","D")

f01         <- ac(0:1)
f26         <- ac(2:6)

stf.options <- c("fmsyAR",
                 'fmsyAR_transfer',
                 'fmsyAR_no_transfer',
                 "mpA",
                 "mpAC",
                 "mpAD",
                 "mpB",
                 "fmsy",
                 "nf",
                 "tacro",
                 "-15%",
                 "+15%",
                 "fsq",
                 "fpa",
                 "flim",
                 "bpa",
                 "blim",
                 "MSYBtrigger")
# mp    =according to management plan,
# +/-%  =TAC change,
# nf    =no fishing,
# bpa   =reach BPA in CtY or if ssb > bpa fish at fpa,
# tacro =same catch as last year
# fmsy  = fmsy implemented
# flim,fpa,blim,bpa = reach F or biomass targets

#-------------------------------------------------------------------------------
# 3) TAC information, reference points and management rule
#
# Note 1: TACS are the realised NSAS catches for the different fleets
# Note 2: TACS.orig are the original set TACs
#-------------------------------------------------------------------------------

############## reference points ##############
#- Set reference points (Fstatus-quo will be filled after intermediate year
referencePoints <- list(Fmsy = 0.26,
                        Fsq  = NA,
                        Flim = 0.34,
                        Fpa  = 0.30,
                        Blim = 800000,
                        Bpa  = 900000,
                        MSYBtrigger = 1400000,
                        Ftarget  = 0, # set this for individual cases
                        F01   = 0.05,
                        Btrigger = 0) # set this for individual cases

############## TAC variables in the ImY ##############
# initialize TAC variables array
TAC_var                   <- list(Ctransfer = NA,
                                  Csplit = NA,
                                  Dsplit = NA,
                                  WBSS_NSAS = NA,
                                  Buptake = NA,
                                  Duptake = NA)

# Splits of WBSS and NSAS 
# Note: splits are only available up to the terminal year
# Note: split in table are the percentage of WBSS in the total catch. Split for NSAS is 1-split
splitTab            <- read.table(file.path(dataPath,'TAC_var','NSAS_split.csv'),sep = ",",header=T) # historical C fleet WBSS/NSAS split (Henrik Mosegaard)
rownames(splitTab)  <- splitTab[,1]

# C split as average over the last 3 years
TAC_var$Csplit      <- mean(1-splitTab[ac((an(DtY)-2):an(DtY)),'C'])    # Proportion NSAS in C fleet catch; 3 year average 
TAC_var$Dsplit      <- mean(1-splitTab[ac((an(DtY)-2):an(DtY)),'D'])    # Proportion NSAS in C fleet catch; 3 year average 

# proportion WBSS caught in North Sea. use hard value from HAWG2018. Need to ask Norbert for historical values
TAC_var$WBSS_NSAS   <- splitTab[DtY,'WBSS_NSAS']

# Ctransfer. Transfer of TAC from IIIa to IVa for C fleet in assessment year
# Note: C transfer in table is the percentage transferred to NSAS from WBSS
CtransferTab            <- read.table(file.path(dataPath,'TAC_var','NSAS_C_transfer.csv'),sep = ",",header=T)
rownames(CtransferTab)  <- CtransferTab[,1]
TAC_var$Ctransfer       <- CtransferTab[ImY,2]

# B & D fleets uptakes (Henrik Mosegaard)
# What should we assume for the uptake?
uptakeTab               <- read.table(file.path(dataPath,'TAC_var','NSAS_uptake.csv'),sep = ",",header=T)
rownames(uptakeTab)     <- uptakeTab[,1]
TAC_var$Buptake         <- mean(uptakeTab[ac((an(DtY)-2):an(DtY)),'B'])   # Uptake of Bfleet as 3 year average
TAC_var$Duptake         <- mean(uptakeTab[ac((an(DtY)-2):an(DtY)),'D'])   # Uptake of the Dfleet as 3 year average

############## TAC for the different fleets in the intermediate year ##############
# TAC A is TACNSA; HER/4AB. + HER/4CXB7D 
# TAC B is TACNSB; HER/2A47DX 
# TAC C is TAC3aC; HER/03A.
# TAC D is TAC3aD; HER/03A-BC

# TAC information for current year
TACTab            <- read.table(file.path(dataPath,'TAC_var','NSAS_TAC.csv'),sep = ",",header=T)
rownames(TACTab)  <- TACTab[,1]

# Create TAC objects for current year, forecast year and last year
TACS        <- FLQuant(NA,dimnames=list(age="all",year=FuY,unit=c("A","B","C","D"),
                                        season="all",area=1,iter=1:dims(NSH)$iter))

TACS[,ImY,'A'] <- TACTab[ImY,'A']
TACS[,ImY,'B'] <- TACTab[ImY,'B']
# assume 0 TAC for FcY and CtY for C and D fleet
TACS[,ImY,'C'] <- TACTab[ImY,'C']
TACS[,ImY,'D'] <- TACTab[ImY,'D']

# TAC C and D fleet in FcY and CtY
# set TAC to 0.1 if 0 catch (for optimizers)
if(TAC_CD_advice == TRUE){
  TACS[,c(FcY,CtY),'C'] <- TACTab[FcY,'C']
  if(TACS[,FcY,'C'] == 0){
    TACS[,c(FcY,CtY),'C'] <- 0.1
  }
}else{
  TACS[,c(FcY,CtY),'C'] <- TACTab[ImY,'C']
}

# D fleet
if(TAC_CD_advice == TRUE){
  TACS[,c(FcY,CtY),'D'] <- TACTab[FcY,'D']
  if(TACS[,FcY,'D'] == 0){
    TACS[,c(FcY,CtY),'D'] <- 0.1
  }
}else{
  TACS[,c(FcY,CtY),'D'] <- TACTab[ImY,'D']
}

############## realised catches ##############
CATCH        <- FLQuant(NA,dimnames=list( age="all",year=FuY,unit=c("A","B","C","D"),
                                          season="all",area=1,iter=1:dims(NSH)$iter))

CATCH[,ImY,'A'] <- TACS[,ImY,'A'] + TAC_var$Ctransfer*TACS[,ImY,'C'] - (TACS[,ImY,'A'] + TAC_var$Ctransfer*TACS[,ImY,'C'])*TAC_var$WBSS_NSAS
CATCH[,ImY,'B'] <- TACS[,ImY,'B']*TAC_var$Buptake
CATCH[,ImY,'C'] <- TACS[,ImY,'C']*(1-TAC_var$Ctransfer)*TAC_var$Csplit
CATCH[,ImY,'D'] <- TACS[,ImY,'D']*TAC_var$Dsplit*TAC_var$Duptake

# assume same catch as ImY
# This is an alternative to the previous procedure of estimating the B-fleet catch from the Management plan
CATCH[,c(FcY,CtY),'B'] <- CATCH[,ImY,'B']

# zero catch in FcY and CtY for C and D fleet, because of zero catch advice for WBSS herring
if(TACS[,FcY,'C'] == 0.1){
  CATCH[,c(FcY,CtY),'C'] <- 0.1
}else{
  CATCH[,c(FcY,CtY),'C'] <- TACS[,FcY,'C']*(1-TAC_var$Ctransfer)*TAC_var$Csplit
}
if(TACS[,FcY,'D'] == 0.1){
  CATCH[,c(FcY,CtY),'D'] <- 0.1
}else{
  CATCH[,c(FcY,CtY),'D'] <- TACS[,FcY,'D']*TAC_var$Dsplit*TAC_var$Duptake
}

#-------------------------------------------------------------------------------
# 4) Recruitment for intermediate, forecast and continuation years
#    ImY recruitment: comes from sf assessment (informed by IBTS0)
#    FcY and CtY: weighted average over 10 year using uncertainty as weighting
#-------------------------------------------------------------------------------
# Retrieve uncertainty estimate on recruitment estimates by the model for weighted average
recWeights  <- subset(NSH.sam@params, name=="logR")$std.dev^2

# fill in recruitment for the different years
RECS <- FLQuants( "ImY" =FLQuant(subset(rec(NSH.sam),year==ImY)$value),
                  "FcY" =exp(apply(log(rec(NSH)[,ac((an(DtY)-10):DtY)]),3:6,weighted.mean,w=1/rev(rev(recWeights)[2:12]),na.rm=T)),
                  "CtY" =exp(apply(log(rec(NSH)[,ac((an(DtY)-10):DtY)]),3:6,weighted.mean,w=1/rev(rev(recWeights)[2:12]),na.rm=T)))


#-------------------------------------------------------------------------------
# 5) Setup stock file
#-------------------------------------------------------------------------------

# Create an stf object 
stf         <- FLStock(name=nam,
                       desc=dsc,
                       m=FLQuant(NA,
                                 dimnames=dms))

# copy fields from current assessment to all fleets
for(i in dms$unit)
  stf[,,i]  <- window(NSH,start=an(dms$year)[1],end=rev(an(dms$year))[1])

units(stf)  <- units(NSH)

# Fill slots that are the same for all fleets
for(i in c(unlist(yrs1),unlist(yrs3),unlist(yrs5))){
  if(i %in% unlist(yrs1)){ for(j in dms$unit){ slot(stf,i)[,FuY,j] <- slot(NSH,i)[,DtY]}}
  if(i %in% unlist(yrs3)){ for(j in dms$unit){ slot(stf,i)[,FuY,j] <- yearMeans(slot(NSH,i)[,ac((an(DtY)-2):an(DtY))])}}
  if(i %in% unlist(yrs5)){ for(j in dms$unit){ slot(stf,i)[,FuY,j] <- yearMeans(slot(NSH,i)[,ac((an(DtY)-4):an(DtY))])}}
}

# taking data from multifleet assessment
for(i in 1:length(dms$unit)){
  
  # Fill the D fleet with the data from the B fleet; same selection pattern
  if(i == 4) {
    stf@harvest[,ac(an(dms$year)[1]:(an(dms$year)[1]+2)),4]     <- NSH3f.sam@harvest[,ac(an(dms$year)[1]:(an(dms$year)[1]+2)),,,2]
    stf@harvest[,FuY,4]     <- NSH3f.sam@harvest[,ImY,,,2]
    stf@catch.wt[,FuY,4]    <- NSHs3[["residual"]]@catch.wt[,DtY,,,2]
    stf@landings.wt[,FuY,4] <- NSHs3[["residual"]]@catch.wt[,DtY,,,2]
  }
  
  if(i != 4) {
    stf@harvest[,ac(an(dms$year)[1]:(an(dms$year)[1]+2)),i]     <- NSH3f.sam@harvest[,ac(an(dms$year)[1]:(an(dms$year)[1]+2)),,,i]
    stf@harvest[,FuY,i]     <- NSH3f.sam@harvest[,ImY,,,i]
    stf@catch.wt[,FuY,i]    <- NSHs3[["residual"]]@catch.wt[,DtY,,,i]
    stf@landings.wt[,FuY,i] <- NSHs3[["residual"]]@catch.wt[,DtY,,,i]
  }
}


# Fill slots that have no meaning for NSAS
stf@discards.n[]          <- 0
stf@discards[]            <- 0
stf@discards.wt[]         <- 0

#-------------------------------------------------------------------------------
# 5) Compute F in intermediate year
#-------------------------------------------------------------------------------

# stock number in ImY, using SAM estimate
for(i in dms$unit)
  stf@stock.n[,ImY,i]     <- NSH.sam@stock.n[,ImY]

# computing F 
stf@harvest[,ImY]         <- fleet.harvest(stk=stf,
                                           iYr=ImY,
                                           CATCH=CATCH[,ImY])
for(i in dms$unit){
  stf@catch.n[,ImY,i]     <- stf@stock.n[,ImY,i]*(1-exp(-unitSums(stf@harvest[,ImY])-stf@m[,ImY,i]))*(stf@harvest[,ImY,i]/(unitSums(stf@harvest[,ImY])+stf@m[,ImY,i]))
  stf@catch[,ImY,i]       <- computeCatch(stf[,ImY,i])
  stf@landings.n[,ImY,i]  <- stf@catch.n[,ImY,i]
  stf@landings[,ImY,i]    <- computeLandings(stf[,ImY,i])
}


#Intermediate year stf option table
stf.table <- array(NA,dim=c(c(length(stf.options)+1),12,3),
                   dimnames=list("options"=c("intermediate year",stf.options),
                                 "values" =c("Fbar 2-6 A","Fbar 0-1 B","Fbar 0-1 C","Fbar 0-1 D","Fbar 2-6","Fbar 0-1","Catch A","Catch B","Catch C","Catch D","SSB","SSB"),
                                 "stats"  =c("5%","50%","95%")))

stf.table[1,"Fbar 2-6 A",]                                  <- quantMeans(stf@harvest[f26,ImY,"A"])
stf.table[1,grep("Fbar 0-1 ",dimnames(stf.table)$values),]  <- aperm(quantMeans(stf@harvest[f01,ImY,c("B","C","D")]),c(2:6,1))
stf.table[1,"Fbar 2-6",]                                    <- quantMeans(unitSums(stf@harvest[f26,ImY,]))
stf.table[1,"Fbar 0-1",]                                    <- quantMeans(unitSums(stf@harvest[f01,ImY,]))
stf.table[1,grep("Catch ",dimnames(stf.table)$values),]     <- aperm(harvestCatch(stf,ImY),c(2:6,1))
stf.table[1,grep("SSB",dimnames(stf.table)$values)[1],]     <- quantSums(stf@stock.n[,ImY,1] * stf@stock.wt[,ImY,1] *
                                                                           exp(-unitSums(stf@harvest[,ImY])*stf@harvest.spwn[,ImY,1]-stf@m[,ImY,1]*stf@m.spwn[,ImY,1]) *
                                                                           stf@mat[,ImY,1])

referencePoints$Fsq <- stf.table["intermediate year","Fbar 2-6","50%"]


#-------------------------------------------------------------------------------
# 6) propagate stock number to forecast year setup
#-------------------------------------------------------------------------------

for(i in dms$unit) stf@stock.n[1,FcY,i]                     <- RECS$FcY
for(i in dms$unit) stf@stock.n[2:(dims(stf)$age-1),FcY,i]   <- (stf@stock.n[,ImY,1]*exp(-unitSums(stf@harvest[,ImY])-stf@m[,ImY,1]))[ac(range(stf)["min"]:(range(stf)["max"]-2)),]
for(i in dms$unit) stf@stock.n[dims(stf)$age,FcY,i]         <- apply((stf@stock.n[,ImY,1]*exp(-unitSums(stf@harvest[,ImY])-stf@m[,ImY,1]))[ac((range(stf)["max"]-1):range(stf)["max"]),],2:6,sum,na.rm=T)



#-------------------------------------------------------------------------------
# 9) Expand the Fmsy AR rule a few more years
#-------------------------------------------------------------------------------

# First run the Fmsy AR again
if("fmsyAR" %in% stf.options){
  
  caseName <- "fmsyAR"
  
  res <- fmsyAR_fun(stf,
                    FuY,
                    CATCH,
                    RECS,
                    referencePoints,
                    f01,
                    f26)
  
}



stf2  <- window(res[["stf"]],start=an(dms$year)[1],end=(4+rev(an(dms$year))[1]))
FuY2  <- ac((an(CtY)+1):(an(CtY)+4))
stf2@harvest[,FuY2] <- stf2@harvest[,CtY]

# fill the slots
for(i in c("harvest", "stock.wt", "catch.wt", "mat", "m", "harvest.spwn", "m.spwn")){
  slot(stf2,i)[,FuY2] <- slot(stf2,i)[,CtY]
}

# set appropriate ranges
range(stf2)["minfbar"] <- 2
range(stf2)["maxfbar"] <- 6

# fill the recruitment
stf2@stock.n["0",FuY2] <- stf2@stock.n["0",CtY]

# calculate catch in 2022
for(i in dms$unit){
  stf2@catch.n[,CtY,i]     <- stf2@stock.n[,CtY,i]*(1-exp(-unitSums(stf2@harvest[,CtY])-stf2@m[,CtY,i]))*(stf2@harvest[,CtY,i]/(unitSums(stf2@harvest[,CtY])+stf2@m[,CtY,i]))
  stf2@catch[,CtY,i]       <- computeCatch(stf2[,CtY,i])
}

# calculate stock and catch in 2023-2026
y <- "2023"
for(y in FuY2) {
  j <- an(y)
  
  # age 2 to plusgroup-1
  stf2@stock.n[2:(dims(stf2)$age-1),y]   <- 
    (stf2@stock.n[,ac(j-1),1]*exp(-unitSums(stf2@harvest[,ac(j-1),])-stf2@m[,ac(j-1),1]))[ac(range(stf2)["min"]:(range(stf2)["max"]-2))]
  
  # plusgroup
  stf2@stock.n[dims(stf2)$age,y]         <- 
    apply((stf2@stock.n[,ac(j-1),1]*
             exp(-unitSums(stf2@harvest[,ac(j-1)])-stf2@m[,ac(j-1),1]))[ac((range(stf2)["max"]-1):range(stf2)["max"]),],2:6,sum,na.rm=T)
  #ssb
  stf2@stock[,y] <- quantSums( stf2@stock.n[,y,1] * stf2@stock.wt[,y,1] *
                      exp(-unitSums(stf2@harvest[,y])*stf2@harvest.spwn[,y,1]-stf2@m[,y,1] *
                            stf2@m.spwn[,y,1]) * stf2@mat[,y,1])[,y,1]
  
  
  for(i in dms$unit){
    stf2@catch.n[,y,i]     <- stf2@stock.n[,y,i]*(1-exp(-unitSums(stf2@harvest[,y])-stf2@m[,y,i]))*(stf2@harvest[,y,i]/(unitSums(stf2@harvest[,y])+stf2@m[,y,i]))
    stf2@catch[,y,i]       <- computeCatch(stf2[,y,i])
  }
}

stf2@stock[,] <- quantSums( stf2@stock.n[,,1] * stf2@stock.wt[,,1] *
                               exp(-unitSums(stf2@harvest[,])*stf2@harvest.spwn[,,1]-stf2@m[,,1] *
                                     stf2@m.spwn[,,1]) * stf2@mat[,,1])[,,1]



# convert to dataframe
stf2.df <- as.data.frame(stf2) %>% 
  bind_rows(., mutate(as.data.frame(fbar(stf2)[,,1]), slot="FA2-6")) %>% 
  bind_rows(., mutate(as.data.frame(rec(stf2)[,,1]), slot="rec", age=as.character(age)))

# calculate catch
# stf2.df %>% 
#   filter(slot %in% c("catch")) %>%
#   group_by(slot, year) %>% 
#   summarize(data = sum(data, na.rm=TRUE))

# calculate ssb
# as.data.frame(ssb(stf2)) %>% 
#   filter(unit %in% c("A")) %>%
#   group_by(year) %>% 
#   summarize(data = sum(data, na.rm=TRUE))

# Figure 2.7.2.3. North Sea Herring. Expanded short term projections using an F status quo from TAC year (i.e. advice year). Inter-mediate year is in 2020 and the TAC year is 2021.

# plot
stf2.df %>% 
  filter(slot %in% c("stock","catch", "FA2-6", "rec"), 
         unit=="A") %>%

  ggplot(aes(x=year,y=data)) +
  theme_publication() +
  theme(legend.position = "none") +
  geom_vline(xintercept=2021, linetype="dashed", size=1, colour="darkgray") +
  geom_line(aes(colour=slot), size=1) +
  labs(x="", y="") +
  expand_limits(y=0) +
  facet_wrap(~slot, scales="free_y")

ggsave(file=file.path(outPath, 
                      paste0("STF_", FuY2[1],"-",FuY2[length(FuY2)],".jpg")), 
       width=30, height=16, units="cm", device="jpeg", dpi=300)


```

**Figure 2.7.2.3. North Sea Herring. Longer term short-term projections using an F status quo F from TAC year (i.e. advice year). Intermediate year is `r y2` and the TAC year is `r y2+1`.**



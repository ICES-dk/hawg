{
    "collab_server" : "",
    "contents" : "#setwd(\"C:/ICES/HAWG2016/Julios\")\n#setwd(\"C:/ICES/HAWG2016/Julios/WG2015\")\nsetwd(\"L:/PERSONAL/Afra/ASAP/2017 HAWG FINAL/julios/WG2017\")\n\nrm(list=ls())\n\nsource(\"funcs.r\")\n\n#9 plots\nlayout(matrix(c(1,2,3,4,5,6,7,8,9), 3, 3, byrow = TRUE))\n\n#request SR data file\n#file should contain columns named year, R and SSB\nSRdatafile <- winDialogString(\"SR Data File?\",\"sr.data.txt\")\n\n#output filename?\noutfile <- winDialogString(\"Output data file?\",paste(SRdatafile,\".out\",sep=\"\"))\n\nsink(outfile)\n\n#age at recruitment?\nRecAge <- winDialogString(\"Recruitment Age?\",\"0\")\n\n#read in the data\nsr.data <- read.table(SRdatafile, header=T)\n\n#the recruitment data series needs to be offset by the recruitment age in\n#order that the values correspond to the appropriate SSB values\nif (as.integer(RecAge)>0) {\n   for (j in 1:as.integer(RecAge)) {\n      #shift the recruitment vector\n      for (i in 1:(length(sr.data$R)-1)) {\n\t sr.data$R[i]<-sr.data$R[i+1]\n      }\n   }\n\n   Recr<-sr.data$R[1:(length(sr.data$R)-as.integer(RecAge))]\n   SSB<-sr.data$SSB[1:(length(sr.data$SSB)-as.integer(RecAge))]\n   Year<-sr.data$year[1:(length(sr.data$year)-as.integer(RecAge))]\n\n} else {\n\n   Recr<-sr.data$R\n   SSB<-sr.data$SSB\n   Year<-sr.data$year\n\n}\n\n#R vs SSB plot\nplot(SSB,\n     Recr, \n     col=4, \n     xlab=\"SSB\",           \n     ylab=\"Recruitment\", \n     xlim=c(0,max(SSB)), \n     ylim=c(0,max(Recr)))\n\n#julios algorithm\njul.mod <- slm2.sr(SSB,Recr)\n\n#print data\nprint(\"*****jul.mod*****\")\nprint(jul.mod)\n\njul.mod <- changepoint.sr(SSB, Recr, delta=jul.mod$delta, constrained=T)\n\n#grid search\ngs.mod <- slm.sr(SSB, Recr, grid=500)\n\n#print data\nprint(\"*****gs.mod*****\")\nprint(gs.mod)\n\ngs.mod <- changepoint.sr(SSB, Recr, delta=gs.mod$delta, constrained=T)\n\n#plot showing data and changepoint\nplot(SSB, Recr, type=\"n\", xlab=\"SSB\", ylab=\"Recruitment\",main=\"Stock Recruit Relationship\", xlim=c(0,max(SSB)), ylim=c(0,max(Recr)),cex.axis=0.8)\ntext(SSB, Recr, Year, cex=0.5)\nlines( c(0,jul.mod$delta), c(0, jul.mod$beta1*jul.mod$delta), lty=1)\nlines( c(jul.mod$delta, max(SSB)), c(jul.mod$alpha2, jul.mod$alpha2), lty=1)\nabline(v=jul.mod$delta, col=2, lty=2)\n\n#q-q plot\nqqnorm(jul.mod$res)\nqqline(jul.mod$res)\n\n#histogram of residuals\nhist(jul.mod$res, nclass=10)\n\nn <- length(Year)\n\n#work backwards, removing 1 year each time up to 10 years back\njul.mod00a<-slm2.sr(SSB[1:c(n-0)],Recr[1:c(n-0)])\njul.mod01a<-slm2.sr(SSB[1:c(n-1)],Recr[1:c(n-1)])\njul.mod02a<-slm2.sr(SSB[1:c(n-2)],Recr[1:c(n-2)])\njul.mod03a<-slm2.sr(SSB[1:c(n-3)],Recr[1:c(n-3)])\njul.mod04a<-slm2.sr(SSB[1:c(n-4)],Recr[1:c(n-4)])\njul.mod05a<-slm2.sr(SSB[1:c(n-5)],Recr[1:c(n-5)])\njul.mod06a<-slm2.sr(SSB[1:c(n-6)],Recr[1:c(n-6)])\njul.mod07a<-slm2.sr(SSB[1:c(n-7)],Recr[1:c(n-7)])\njul.mod08a<-slm2.sr(SSB[1:c(n-8)],Recr[1:c(n-8)])\njul.mod09a<-slm2.sr(SSB[1:c(n-9)],Recr[1:c(n-9)])\njul.mod10a<-slm2.sr(SSB[1:c(n-10)],Recr[1:c(n-10)])\n\n#vector of delta values\ndelta.a <- c(jul.mod00a$delta,jul.mod01a$delta,jul.mod02a$delta,jul.mod03a$delta,\n\t     jul.mod04a$delta,jul.mod05a$delta,jul.mod06a$delta,jul.mod07a$delta,\n\t     jul.mod08a$delta,jul.mod09a$delta,jul.mod10a$delta)\n\nprint(\"*****delta.a*****\")\nprint(delta.a)\n\n#year vector\nyr <- seq(max(Year)-10,max(Year))\n\nplot(yr, delta.a, type=\"l\", ylim=c(0, c(round(max(delta.a)/1000)*1500)))\n\n#S-R plot showing all breakpoints\nplot(SSB,\n     Recr,\n     type=\"n\",\n     xlab=\"SSB\",\n     ylab=\"Recruitment\",\n     xlim=c(0,max(SSB)),\n     ylim=c(0,max(Recr)))\n\ntext(SSB,Recr,Year,cex=0.5)\n\nlines(c(0,jul.mod$delta),c(0,jul.mod$beta1*jul.mod$delta),col=\"dark red\",lwd=2,lty=1)\nlines(c(jul.mod$delta, max(SSB)), c(jul.mod$alpha2, jul.mod$alpha2), col=\"dark red\", lwd=2, lty=1)\nabline(v=jul.mod$delta, col=2, lty=2)\nlines( c(1, jul.mod01a$delta), c(0, jul.mod01a$beta1*jul.mod01a$delta), lty=2)\nlines( c(jul.mod01a$delta, max(SSB)), c(jul.mod01a$alpha2, jul.mod01a$alpha2), lty=2)\nlines( c(0, jul.mod02a$delta), c(0, jul.mod02a$beta1*jul.mod02a$delta), lty=2)\nlines( c(jul.mod02a$delta, max(SSB)), c(jul.mod02a$alpha2, jul.mod02a$alpha2), lty=2)\nlines( c(0, jul.mod03a$delta), c(0, jul.mod03a$beta1*jul.mod03a$delta), lty=2)\nlines( c(jul.mod03a$delta, max(SSB)), c(jul.mod03a$alpha2, jul.mod03a$alpha2), lty=2)\nlines( c(0, jul.mod04a$delta), c(0, jul.mod04a$beta1*jul.mod04a$delta), lty=2)\nlines( c(jul.mod04a$delta, max(SSB)), c(jul.mod04a$alpha2, jul.mod04a$alpha2), lty=2)\nlines( c(0, jul.mod05a$delta), c(0, jul.mod05a$beta1*jul.mod05a$delta), lty=2)\nlines( c(jul.mod05a$delta, max(SSB)), c(jul.mod05a$alpha2, jul.mod05a$alpha2), lty=2)\nlines( c(0, jul.mod06a$delta), c(0, jul.mod06a$beta1*jul.mod06a$delta), lty=2)\nlines( c(jul.mod06a$delta, max(SSB)), c(jul.mod06a$alpha2, jul.mod06a$alpha2), lty=2)\nlines( c(0, jul.mod07a$delta), c(0, jul.mod07a$beta1*jul.mod07a$delta), lty=2)\nlines( c(jul.mod07a$delta, max(SSB)), c(jul.mod07a$alpha2, jul.mod07a$alpha2), lty=2)\nlines( c(0, jul.mod08a$delta), c(0, jul.mod08a$beta1*jul.mod08a$delta), lty=2)\nlines( c(jul.mod08a$delta, max(SSB)), c(jul.mod08a$alpha2, jul.mod08a$alpha2), lty=2)\nlines( c(0, jul.mod09a$delta), c(0, jul.mod09a$beta1*jul.mod09a$delta), lty=2)\nlines( c(jul.mod09a$delta, max(SSB)), c(jul.mod09a$alpha2, jul.mod09a$alpha2), lty=2)\nlines( c(0, jul.mod10a$delta), c(0, jul.mod10a$beta1*jul.mod10a$delta), lty=2)\nlines( c(jul.mod10a$delta, max(SSB)), c(jul.mod10a$alpha2, jul.mod10a$alpha2), lty=2)\n\n#now remove individual years\ndeltas<-c()\nfor (i in 1:length(Year)) {\n   jul.mod<-slm2.sr(SSB[-i],Recr[-i])\n   deltas<-c(deltas,jul.mod$delta)\n\n}\n\nprint(\"*****deltas*****\")\nprint(deltas)\n\nplot(Year, deltas, type=\"l\",  ylim=c(0, c(round(max(deltas)/1000)*1500)))\n\nmean.mod <- lm(log(Recr)~1)\nmean.ssq <- sum(residuals(mean.mod)^2)\nprint(\"*****Summary(mean.mod)*****\")\nprint(summary(mean.mod))\nprint(\"*****mean.ssq*****\")\nprint(mean.ssq)\n\nline.mod <- lm(log(Recr)~1, offset=log(SSB))\nline.ssq <- sum(residuals(line.mod)^2)\nprint(\"*****summary(line.mod)*****\")\nprint(summary(line.mod))\nprint(\"*****line.ssq*****\")\nprint(line.ssq)\n\nf.obs <- (mean.ssq - jul.mod$ssq)*(n-2)/jul.mod$ssq\n\nprint(\"*****f.obs*****\")\nprint(f.obs)\n\ndate()\nf <- boot.sr(SSB, Recr, iter=1000)\ndate()\n\nplot(ecdf(f$f.all), verticals=T, do.p=F, xlab=\"F statistic\", main=\"Empirical distribution\")\nabline(v=f$f.obs, lty=2, col=2)\n\nprint(\"*****f*****\")\nprint(f)\n\nsink()\n\n#SR plot + fit\n#1 plot\njpeg(file=\"JuliosFitSR.jpg\",height=500,width=800)\n\nlayout(matrix(c(1), 1, 1, byrow = TRUE))\n\nplot(SSB/1000, Recr/1e3, col=4, xlab=\"SSB (kt)\", ylab=\"Recruitment (Millions)\", \n     xlim=c(0,175), ylim=c(0,max(Recr/1e3)),pch=19,bty=\"n\",axes=F)\ntext(SSB/1000,Recr/1e3,Year,cex=0.75,pos=3)\nlines(c(0,(537900/1e3)/9.462927,max(SSB/1000)),c(0,537900/1e3,537900/1e3))\nlines(c((537900/1e3)/9.462927,(537900/1e3)/9.462927),c(0,537900/1e3),lty=2)\naxis(side=1,at=c(0,25,50,75,100,125,150,175))\naxis(side=2,at=c(0,250,500,750,1000,1250,1500))\n\ndev.off()\n",
    "created" : 1489500340801.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1493592349",
    "id" : "2EC1C1B0",
    "lastKnownWriteTime" : 1489497837,
    "last_content_update" : 1489497837,
    "path" : "L:/PERSONAL/Afra/ASAP/2017 HAWG FINAL/Julios/WG2017/SegReg_old.R",
    "project_path" : "SegReg_old.R",
    "properties" : {
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}
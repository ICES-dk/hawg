{
    "collab_server" : "",
    "contents" : "################################################################################\n# Code to do the short term forecast for Celtic Sea Herring\n#\n# By: Afra Egan\n\n# February 2015\n#\n# R 3.0.3\n\n\n#install.packages(\"FLCore\", repos=\"http://flr-project.org/R\")\n\n### ======================================================================================================\n### Initialise system, including convenience functions and title display\n### ======================================================================================================\nrm(list=ls()); gc(); graphics.off(); start.time <- proc.time()[3]\noptions(stringsAsFactors=FALSE)\n\n#library(FLEDA)'AC\nlibrary(FLCore)\nlibrary(FLash)\n\n#-Load the libraries needed\nlibrary(MASS)#7.2-47\n#library(minpack.lm)'AC\n\n\n\n### ======================================================================================================\n\n\n#- Perhaps, set a path here\n\n#path<-\"W:/PERSONAL/Afra/HAWG 2015/Celtic Sea/2015 Forecast/FLR/Final assessment new nat mor/\"\n\n#path<-\"W:/PERSONAL/Afra/HAWG 2015/Celtic Sea/2015 Forecast/FLR/Final Run with all figures 24_03/\"\npath<-\"L:/PERSONAL/Afra/ASAP/2017 HAWG FINAL/\"\n\ntry(setwd(path))\n\n#try(setwd(\"./stf/\"))\n\n#path  <- getwd()\n\n### ======================================================================================================\ndata.source  <-  file.path(\"stf_HAWG_FINAL_2017\")      #Data source\noutput.dir   <-  file.path(\"stf_HAWG_FINAL_2017\")       #Output directory\noutput.base  <-  file.path(output.dir)\n### ======================================================================================================\n\n### Read in the data\n### ======================================================================================================\n\nCSH<- readFLStock(file.path(data.source, \"index.txt\"),no.discards=TRUE)\n#Set no discards\nCSH@catch.n                <- CSH@landings.n\nCSH@catch                  <- CSH@landings\nCSH@catch.wt               <- CSH@landings.wt\nunits(CSH)[1:17]           <- as.list(c(rep(c(\"tonnes\",\"thousands\",\"kg\"),4), rep(\"NA\",5)))\n\n\n\n#Set fbar\nrange(CSH)[c(\"minfbar\",\"maxfbar\")] <- c(2,5)\n\n#Set plus group\nCSH<- setPlusGroup(CSH,CSH@range[\"max\"])\n\n#Set stock object name - this is propagated through into the figure titles\nCSH@name    <- \"Celtic Sea Herring\"\n\n### ======================================================================================================\n### Read in the index\n### ======================================================================================================\n\n#Load and modify all index data\nCSH.tun   <- readFLIndices(file.path(data.source, \"fleet.txt\"))\n\n#Set names, and parameters etc\nnames(CSH.tun) <-  gsub(\":.*$\",\"\",names(CSH.tun))\nCSH.tun   <- lapply(CSH.tun,function(idx) {\n                idx@type \t     <- \t\"number\"\n          \t\tidx@index.var[]  <-\t1\n                idx@range[\"plusgroup\"] <- NA\n          \t\treturn(idx)})\n\n\nnames(CSH.tun)[1] <- c(\"Celtic Sea Herring Acoustic\")\n\n \n#===============================================================================\n\n###- Load the assessment output objects from the ASAP assessment\n### Add to the CSH FLStock object\n\n\nCSH@stock.n<-readVPAFile(file.path(data.source, \"N.txt\"))\n\nCSH@harvest<-readVPAFile(file.path(data.source, \"F.txt\"))\nunits(CSH@harvest)<-'f'\n\n\n#CSH\n\n#stk <- CSH\nsummary(CSH)\n \n\n\nstk<-CSH\n\n### ======================================================================================================\n### Projections\n### ======================================================================================================\n\n## three year forecast\n#Define years\n\nlibrary(FLAssess)\n#Define years\nTaY <- dims(CSH)$maxyear   #Terminal assessment year\nImY <- TaY+1                #Intermediate Year\nAdY <- TaY+2                #Advice year\nCtY <- TaY+3                #Continuation year - not of major concern but used in calculations in places\ntbl.yrs     <- as.character(c(ImY,AdY,CtY))   #Years to report in the output table\n\n\n\n# use breakpoint from julios stock recruitment\nrec<-541287\n## use geomean stock recruit\nCSH.srr <- list(model=\"geomean\",params=FLPar(rec))\n\n\n\n#Expand stock object\n\nCSH.proj <- stf(CSH,nyears=3,wts.nyears=3,arith.mean=TRUE,na.rm=TRUE)\n\nCSH.proj@stock.n[ac(2:9),ac(ImY)]  <- CSH@stock.n[ac(1:8),ac(TaY)] * exp(-CSH@harvest[ac(1:8),ac(TaY)]-CSH@m[ac(1:8),ac(TaY)])\n\nCSH.proj@stock.n[ac(9),ac(ImY)]    <- CSH.proj@stock.n[ac(9),ac(ImY)] + CSH@stock.n[ac(9),ac(TaY)] * exp(-CSH@harvest[ac(9),ac(TaY)]-CSH@m[ac(9),ac(TaY)])\n\nCSH.proj@stock.n[1,as.character(c(ImY,AdY,CtY))] <- rec\n\n# check values\nCSH.proj@stock.n\n\n\n#Define some constants\nImY.catch <- 18356  \nAdY.catch <- 15652 #2015 TAC\nnumFmsy <- 0.26\nnumFmgt<-0.23\n\n\n#Setup options\noptions.l <- list(#Zero catch\n  \"Catch(2016) = Zero\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=\"catch\",\n                          val=c(ImY.catch,0,0))),\n  #Intermediate year catch equal TAC, followed by -15% Catch reduction\n  \"Catch(2016) = 2015 TAC -15%\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"catch\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,AdY.catch*0.85,NA))),\n  #Intermediate year catch equal TAC, followed by +0% Catch increase\n  \"Catch(2016) = 2015 TAC\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"catch\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,AdY.catch*1,NA))),\n  #Intermediate year catch equal TAC, followed by +15% Catch increase\n  \"Catch(2016) = 2015 TAC +15%\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"catch\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,AdY.catch*1.15,NA))),\n  #Intermediate year catch equal TAC, followed by +30% Catch increase\n  \"Catch(2016) = 2015 TAC +30%\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"catch\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,AdY.catch*1.30,NA))),\n  #Intermediate year catch equal TAC, followed by -30% Catch reduction\n  \"Catch(2016) = 2015 TAC -30%\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"catch\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,AdY.catch*0.70,NA))),\n  #Intermediate year catch equal TAC, followed Fbar = Fmsy (0.24)\n  \"Fbar(2016) = Fmsy\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"f\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,numFmsy,NA))),\n  #Intermediate year catch equal TAC, followed Fbar = Fmgt (0.23)\n  \"Fbar(2016) = Fmgt\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"f\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,numFmgt,NA))),\n  \"Fbar(2016) = 0.18\"=\n    fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                          quantity=c(\"catch\",\"f\",\"f\"),\n                          rel=c(NA,NA,AdY),\n                          val=c(ImY.catch,0.18,NA)))\n) #End options list\n\n\n#Multi-options table\nfmult.targs  <- seq(0,2,by=0.1)\nmult.opts.l <- lapply(as.list(fmult.targs),function(fmult) {\n  fwdControl(data.frame(year=c(ImY,AdY,CtY),\n                        quantity=c(\"catch\",\"f\",\"f\"),\n                        rel=c(NA,ImY,AdY),\n                        val=c(ImY.catch,fmult,1)))\n})\nnames(mult.opts.l) <- sprintf(\"Fmult(2016) = %4.3f\",fmult.targs)\n\n#Calculate options\nCSH.options   <- lapply(options.l,function(ctrl) {fwd(CSH.proj,ctrl=ctrl,sr=CSH.srr)})\nCSH.mult.opts <- lapply(mult.opts.l,function(ctrl) {fwd(CSH.proj,ctrl=ctrl,sr=CSH.srr)})\n\ninput.tbl.file <-file.path(output.dir,\"options - input.csv\",sep=\".\")\nwrite.table(NULL,file=input.tbl.file,col.names=FALSE,row.names=FALSE)\ninput.tbl.list <- list(N=\"stock.n\",M=\"m\",Mat=\"mat\",PF=\"harvest.spwn\",\n                       PM=\"m.spwn\",SWt=\"stock.wt\",Sel=\"harvest\",CWt=\"catch.wt\")\nfor(yr in c(ImY,AdY,CtY)){\n  col.dat <- sapply(input.tbl.list,function(slt) slot(CSH.proj,slt)[,as.character(yr),drop=TRUE])\n  write.table(yr,file=input.tbl.file,col.names=FALSE,row.names=FALSE,append=TRUE,sep=\",\")\n  write.table(t(c(\"Age\",colnames(col.dat))),file=input.tbl.file,col.names=FALSE,row.names=FALSE,append=TRUE,sep=\",\")\n  write.table(col.dat,file=input.tbl.file,col.names=FALSE,row.names=TRUE,append=TRUE,sep=\",\",na=\"-\")\n  write.table(\"\",file=input.tbl.file,col.names=FALSE,row.names=FALSE,append=TRUE,sep=\",\")\n}\n\n#Detailed options table\noptions.file <-file.path(output.dir,\"options - details.csv\",sep=\".\")\nwrite.table(NULL,file=options.file,col.names=FALSE,row.names=FALSE)\nfor(i in 1:length(CSH.options)) {\n  opt <- names(CSH.options)[i]\n  stk <- CSH.options[[opt]]\n  #Now the F and N by age\n  nums.by.age <- stk@stock.n[,tbl.yrs,drop=TRUE]\n  colnames(nums.by.age) <- sprintf(\"N(%s)\",tbl.yrs)\n  f.by.age    <- stk@harvest[,tbl.yrs,drop=TRUE]\n  colnames(f.by.age) <- sprintf(\"F(%s)\",tbl.yrs)\n  age.tbl     <- cbind(Age=rownames(f.by.age),N=nums.by.age,F=f.by.age)\n  #And now the summary tbl\n  sum.tbl     <- cbind(Year=tbl.yrs,SSB=ssb(stk)[,tbl.yrs],\n                       F.bar=fbar(stk)[,tbl.yrs],Yield=computeCatch(stk)[,tbl.yrs])\n  #Now, bind it all together\n  sum.tbl.padding <- matrix(\"\",nrow=nrow(age.tbl)-nrow(sum.tbl),ncol=ncol(sum.tbl))\n  comb.tbl    <- cbind(age.tbl,\" \",rbind(sum.tbl,sum.tbl.padding))\n  #And write it - hdr first, then the rest\n  write.table(sprintf(\"%s). %s\",letters[i],opt),options.file,append=TRUE,col.names=FALSE,row.names=FALSE,sep=\",\")\n  write.table(t(colnames(comb.tbl)),options.file,append=TRUE,col.names=FALSE,row.names=FALSE,sep=\",\")\n  write.table(comb.tbl,options.file,append=TRUE,col.names=FALSE,row.names=FALSE,sep=\",\")\n  write.table(c(\"\"),options.file,append=TRUE,col.names=FALSE,row.names=FALSE,sep=\",\")\n}\n\n#Options summary table\nopt.sum.tbl <- function(stcks,fname) {\n  options.sum.tbl <- sapply(as.list(1:length(stcks)),function(i) {\n    opt <- names(stcks)[i]\n    stk <- stcks[[opt]]\n    #Build up the summary\n    sum.tbl     <- data.frame(Rationale=opt,\n                              F.ImY=fbar(stk)[,as.character(ImY),drop=TRUE],\n                              Catch.ImY=computeCatch(stk)[,as.character(ImY),drop=TRUE],\n                              SSB.ImY=ssb(stk)[,as.character(ImY),drop=TRUE],\n                              F.AdY=fbar(stk)[,as.character(AdY),drop=TRUE],\n                              Catch.AdY=computeCatch(stk)[,as.character(AdY),drop=TRUE],\n                              SSB.AdY=ssb(stk)[,as.character(AdY),drop=TRUE],\n                              SSB.CtY=ssb(stk)[,as.character(CtY),drop=TRUE])\n  })\n  options.sum.tbl <- t(options.sum.tbl)\n  colnames(options.sum.tbl) <- c(\"Rationale\",\n                                 sprintf(\"Fbar (%i)\",ImY),sprintf(\"Catch (%i)\",ImY),sprintf(\"SSB (%i)\",ImY),\n                                 sprintf(\"Fbar (%i)\",AdY),sprintf(\"Catch (%i)\",AdY),sprintf(\"SSB (%i)\",AdY),\n                                 sprintf(\"SSB (%i)\",CtY))\n  write.csv(options.sum.tbl,file=fname,row.names=FALSE)\n}\nopt.sum.tbl(stcks=CSH.options,fname=file.path(output.base,\"options - summary.csv\",sep=\".\"))\nopt.sum.tbl(stcks=CSH.mult.opts,fname=file.path(output.base,\"multi-options - summary.csv\",sep=\".\"))\n\n\n\n\n",
    "created" : 1489490223695.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1465104666",
    "id" : "CD6DBD8F",
    "lastKnownWriteTime" : 1489491425,
    "last_content_update" : -2147483648,
    "path" : "L:/PERSONAL/Afra/ASAP/2017 HAWG FINAL/stf_HAWG_FINAL_2017/STF_CSH_julios.r",
    "project_path" : "STF_CSH_julios.r",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}